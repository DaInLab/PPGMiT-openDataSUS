---
title: "Dashboard Óbitos COVID-19 no Brasil"
runtime: shiny

output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source_code: embed
    navbar:
      - { title: "Sobre Mim", href: "https://www.linkedin.com/in/marcelo-j-santos/", align: right }
      - { icon: fa-address-card, href: "https://example.com/about", align: right }
---

<style type="text/css">

.value-box {
display: flex;
align-items: center;
justify-content: center;
align-content: center;
}

.value-box .value {
    color: white;
    font-size : 140%
}
.value-box .caption {
    color: white;
    font-size : 105%
}
</style>

```{r setup, include=FALSE}
#knitr::opts_knit$set(root.dir = getwd())

# Diretorio da Trabalho
# setwd(file.path("d:", "GoogleDrive","Mestrado","PPGMiT-openDataSUS"))

# Carregando as bibliotecas necessárias


if (!("ggplot2") %in% installed.packages()) install.packages("ggplot2")   
if (!("dplyr") %in% installed.packages()) install.packages("dplyr")
if (!("readr") %in% installed.packages()) install.packages("readr")
if (!("knitr") %in% installed.packages()) install.packages("knitr")
if (!("flexdashboard") %in% installed.packages()) install.packages("flexdashboard")   
if (!("shiny") %in% installed.packages()) install.packages("shiny")
if (!("plotly") %in% installed.packages()) install.packages("plotly")


#if (!("geobr") %in% installed.packages()) install.packages("geobr")
#if (!("scales") %in% installed.packages()) install.packages("scales")
#if (!("ggspatial") %in% installed.packages()) install.packages("ggspatial")
#if (!("kableExtra") %in% installed.packages()) install.packages("kableExtra")
#if (!("knitr") %in% installed.packages()) install.packages("knitr")

library(ggplot2) # Visualizacao dos dados
library(dplyr)   # Preparacao de dados
library(readr)   # Importacao dos dados
library(flexdashboard)
library(shiny)
library(shinyWidgets)
library(knitr)
library(plotly)


#library(geobr)   # Mapa do Brasil
#library(gt)
#library(scales)
##library(ggspatial)
#library(kableExtra)

#library("devtools")
#library(DT)
#library(tidyverse)

#library(ggplot2)
#library(readr)
#library(lubridate)

#library(stringr)
#library(forcats)
#library(tidyr)
#library(scales)
##library(ggtext)
##library(tsibble)
#library(fabletools)
#library(feasts)
#library(Hmisc)

#library(ggplot2) # Visualizacao dos dados
#library(dplyr)   # Preparacao de dados
#library(readr)   # Importacao dos dados
#library(geobr)   # Mapa do Brasil
#library(scales)
#library(ggspatial)
#library(flexdashboard)
#library(knitr)
#library(kableExtra)

# Importacao do arquivo municipios.csv
#df_municipios <- read.csv('./dados/MUNICIPIOS.csv', sep=";") %>% arrange(SG_UF_NOT,ID_MUNICIP)

# Importacao do arquivo covid_totais.csv
df_totais <- read.csv('./dados/COVID_TOTAIS.csv', sep=";") 

df_totais$obitos_md_idade_2021 <- as.numeric(gsub(",", ".", gsub("\\.", "", df_totais$obitos_md_idade_2021)))
df_totais$obitos_md_idade_2022 <- as.numeric(gsub(",", ".", gsub("\\.", "", df_totais$obitos_md_idade_2022)))
df_totais$obitos_md_idade_2023 <- as.numeric(gsub(",", ".", gsub("\\.", "", df_totais$obitos_md_idade_2023)))

# Importacao do arquivo : dashboard.csv
df_dashboard <- read.csv('./dados/DASHBOARD.csv', sep=";") 

# Importacao do arquivo : covid_totais.csv
#df_covid_totais <- read.csv('D:/GoogleDrive/Mestrado/PPGMIT_novo_dashboard/dados/covid_totais.csv', sep=";")


```

Inputs {.sidebar}
-------------------------------------

```{r}

radioGroupButtons(
   inputId = "FiltroAno",
   label = "Ano:",
   choices = c("2021", 
    "2022", "2023"),
   checkIcon = list(
      yes = icon("ok",
   lib = "glyphicon"))
)   

# UF
UF <- c('**TODAS**','AC','AL','AM','AP','BA','CE','ES','GO','MA','MG','MS','MT','PA','PB','PE','PI','PR','RJ','RN','RO','RR','RS','SC','SE','SP','TO')
df_municipios <- distinct(df_totais, SG_UF_NOT, ID_MUNICIP)

selectInput("FiltroUF", 
            label = "Selecione UF Notificação:",  
            choices = UF, 
            selected = "**TODAS**")

g.choices <- reactive({
  df_municipios %>%
    filter(SG_UF_NOT %in% input$FiltroUF)
})

renderUI({
  selectInput("FiltroMunicipio",
    label = "Município:",
    choices = c('**TODOS**',(g.choices()$ID_MUNICIP))
  )
})


df_dados_totais <- reactive({
  
  ## Filtros
  UF <- input$FiltroUF
  Municipio <- input$FiltroMunicipio

  if (UF != "**TODAS**" && Municipio != "**TODOS**") {
     totais <- dplyr::filter(df_totais, SG_UF_NOT == input$FiltroUF & ID_MUNICIP == input$FiltroMunicipio)
   } else if (UF != "**TODAS**" && Municipio == "**TODOS**") {
     totais <- dplyr::filter(df_totais, SG_UF_NOT == input$FiltroUF)
   } else {totais <- df_totais}
  
    return(totais) })

df_dados_dashboard <- reactive({

    ## Filtros
  UF <- input$FiltroUF
  Municipio <- input$FiltroMunicipio

  if (UF != "**TODAS**" && Municipio != "**TODOS**") {
     dashboard <- dplyr::filter(df_dashboard, ANO_EVOLUCA == input$FiltroAno & SG_UF_NOT == input$FiltroUF & ID_MUNICIP == input$FiltroMunicipio)
   } else if (UF != "**TODAS**" && Municipio == "**TODOS**") {
     dashboard <- dplyr::filter(df_dashboard, ANO_EVOLUCA == input$FiltroAno & SG_UF_NOT == input$FiltroUF)
   } else {
     dashboard <- dplyr::filter(df_dashboard, ANO_EVOLUCA == input$FiltroAno)
   }
  
  return(dashboard) })


```

$$\\[.01in]$$

```{r, echo=FALSE, out.width = '50%', fig.align="center"}

knitr::include_graphics("./imagens/FAAC-logo_RGB.png")

knitr::include_graphics("./imagens/ppgmit.jpg")

knitr::include_graphics("./imagens/linda.jpg")
```


Row {data-height=050; data-width=150}
-------------------------------------
### Total Notificações 
```{r}
 renderValueBox({
  
   dados <- df_dados_totais()
   
   switch(input$FiltroAno,
          "2021" = {total_notificacoes <- sum(dados$tot_notifica_2021)},
          "2022" = {total_notificacoes <- sum(dados$tot_notifica_2022)},
          "2023" = {total_notificacoes <- sum(dados$tot_notifica_2023)}
   )
   
  
   if (total_notificacoes == 0) {
      valueBox(value = tags$p("---", style = "color:lightgray; "),
              caption = tags$p("Total Notificações", style = "color:lightgray;font-size: 20px; "),
              icon = icon("list"), color ="white")
   } else {
      valueBox(value = tags$p(format(total_notificacoes, big.mark = "."), style = "font-size: 40px;"),
               caption = tags$p("Total Notificações", style = "color:white;font-size: 20px; "),
               icon = icon("list"), color="darkcyan")    
     }
   
  
})

```

### Cura 

```{r}
renderGauge({
  
  dados <- df_dados_totais()
  
  switch(input$FiltroAno,
          "2021" = {perc_cura <- if (sum(dados$tot_notifica_2021)==0) {0} else {(sum(dados$tot_cura_2021)/sum(dados$tot_notifica_2021))* 100}},
          "2022" = {perc_cura <- if (sum(dados$tot_notifica_2022)==0) {0} else {(sum(dados$tot_cura_2022)/sum(dados$tot_notifica_2022))* 100}},
          "2023" = {perc_cura <- if (sum(dados$tot_notifica_2023)==0) {0} else {(sum(dados$tot_cura_2023)/sum(dados$tot_notifica_2023))* 100}}
   )
  
  gauge(perc_cura, min = 0, max = 100, symbol = '%', label="Cura %", gaugeSectors(
  success = c(60, 100), warning = c(40, 59), danger = c(0, 39),
  colors = c("blue","yellow", "red")))
  
})

```

### Óbito 
```{r}
renderGauge({ 
dados <- df_dados_totais()
   switch(input$FiltroAno,
          "2021" = {perc_obito <- if (sum(dados$tot_notifica_2021)==0) {0} else {(sum(dados$tot_obito_2021)/sum(dados$tot_notifica_2021))* 100}},
          "2022" = {perc_obito <- if (sum(dados$tot_notifica_2022)==0) {0} else {(sum(dados$tot_obito_2022)/sum(dados$tot_notifica_2022))* 100}},
          "2023" = {perc_obito <- if (sum(dados$tot_notifica_2023)==0) {0} else {(sum(dados$tot_obito_2023)/sum(dados$tot_notifica_2023))* 100}}
   )
  
  gauge(perc_obito, min = 0, max = 100, symbol = '%', label="Óbitos %", gaugeSectors(
    success = c(0, 19), warning = c(20, 59), danger = c(60, 100),
    colors = c("blue","yellow", "red")))
})
  
```
    
### Óbito-Outras Causas
```{r}
renderGauge({ 

  dados <- df_dados_totais()
   switch(input$FiltroAno,
          "2021" = {perc_outra <- if (sum(dados$tot_notifica_2021)==0) {0} else {(sum(dados$tot_outra_2021)/sum(dados$tot_notifica_2021))* 100}},
          "2022" = {perc_outra <- if (sum(dados$tot_notifica_2022)==0) {0} else {(sum(dados$tot_outra_2022)/sum(dados$tot_notifica_2022))* 100}},
          "2023" = {perc_outra <- if (sum(dados$tot_notifica_2023)==0) {0} else {(sum(dados$tot_outra_2023)/sum(dados$tot_notifica_2023))* 100}}
   )
  
  gauge(perc_outra, min = 0, max = 100, symbol = '%', label="Outra Causa%", gaugeSectors(
    success = c(0, 19), warning = c(20, 59), danger = c(60, 100),
    colors = c("blue","yellow", "red")))
})


```

### Ignorado
```{r}
renderGauge({ 
 dados <- df_dados_totais()
   switch(input$FiltroAno,
          "2021" = {perc_ignora <- if (sum(dados$tot_notifica_2021)==0) {0} else {(sum(dados$tot_ignora_2021)/sum(dados$tot_notifica_2021))* 100}},
          "2022" = {perc_ignora <- if (sum(dados$tot_notifica_2022)==0) {0} else {(sum(dados$tot_ignora_2022)/sum(dados$tot_notifica_2022))* 100}},
          "2023" = {perc_ignora <- if (sum(dados$tot_notifica_2023)==0) {0} else {(sum(dados$tot_ignora_2023)/sum(dados$tot_notifica_2023))* 100}}
   )
  
  gauge(perc_ignora, min = 0, max = 100, symbol = '%', label="Outra Causa%", gaugeSectors(
    success = c(0, 19), warning = c(20, 59), danger = c(60, 100),
    colors = c("blue","yellow", "red")))
})

```
Row {data-height=50; data-width=50}
-------------------------------------

### Óbitos - COVID-19
```{r}
renderValueBox({
valueBox(value = tags$p("", style = "font-size: 40px;font-size: 40px;"),
                   caption = tags$p("Óbitos - COVID-19", style = "color:white;font-size: 20px; "),
                   icon = icon("list"), color ="orange")
     
  })

```


Column {.tabset}
---
### Idade

```{r}

renderPlotly({

dados <- df_dados_dashboard()    

colors <- c("pink", "orange", "blue")
    
# set the marker properties, including the colors and line width
marker <- list(colors = colors)
    
# define the text and hover information to be displayed on the chart
textinfo <- "label+percent"
hoverinfo <- "text"


df_faixa_etaria <- dados %>%
  group_by(FAIXA_ETARIA) %>% summarize(n = length(NU_IDADE_N))

if (nrow(df_faixa_etaria) == 0) { chart <- plot_ly(
                                            data = df_faixa_etaria,
                                            x = ~ 0,
                                            y = ~ 0,
                                            type = 'bar') 

   ggplotly(chart)}
else {

chart <- plot_ly(
  data = df_faixa_etaria,
  x = ~ FAIXA_ETARIA,
  y = ~ n,
  type = 'bar',
  colors = c('#6bbabf', '#60ab3d'),
  text = ~ paste("<br><b>Óbitos:</b>", n , "<br><b></b>", paste(round(unname(n) / sum(unname(n)) * 100,1), "%")),
  hovertemplate = paste('%{text}<extra></extra>')
) %>% layout(barmode = 'group', yaxis= list(showticklabels = FALSE, title = ""), xaxix = list(title="Faixa Etária"))


ggplotly(chart) }


})
```

### Sexo

```{r}

renderPlotly({

dados <- df_dados_dashboard()    
df_sexo <- dados

colors <- c("pink", "orange", "blue")
    
# set the marker properties, including the colors and line width
marker <- list(colors = colors)
    
# define the text and hover information to be displayed on the chart
textinfo <- "label+percent"
hoverinfo <- "text"

if (nrow(df_sexo) == 0) { chart <- plot_ly(df_sexo, labels = ~0, values = ~0, type = "pie",
                     hole = 0.5, marker = marker,
                     text = ~paste(CS_SEXO, 0, sep = ": "),
                     textinfo = textinfo, hoverinfo = hoverinfo)
   ggplotly(chart)}
else {

df_sexo <- aggregate(dados$CS_SEXO,
                     by=list(CS_SEXO=dados$CS_SEXO), FUN=length) 

for (k in 1:nrow(df_sexo)) {
  if(df_sexo$CS_SEXO[k] == "M") df_sexo$label[k] <- "Masculino"
  if(df_sexo$CS_SEXO[k] == "F") df_sexo$label[k] <- "Feminino"
  if(df_sexo$CS_SEXO[k] == "I") df_sexo$label[k] <- "Ignorado"
}

colors <- c("pink", "orange", "blue")
    
# set the marker properties, including the colors and line width
marker <- list(colors = colors)
    
# define the text and hover information to be displayed on the chart
textinfo <- "label+percent"
hoverinfo <- "text"

chart <- plot_ly(df_sexo, labels = ~label, values = ~x, type = "pie",
                     hole = 0.5, marker = marker,
                     text = ~paste(label, " : ", x, " Óbitos"),
                     textinfo = textinfo, hoverinfo = hoverinfo)
    
# customize the layout of the chart, including the title and legend
  layout(chart, 
  legend = list(x = 0, y = 1, font = list(width = 26, color = "black")))

  ggplotly(chart)

}
 
})


```


### Escolaridade

```{r}

```

### Fatores de Risco 

```{r}

```


### Sinais e Sintomas

```{r}

```

Row {data-height=150; data-width=150}
-------------------------------------

### Óbitos - Fatores de Risco
```{r}

```

### Óbitos - Sinais e Sintomas
```{r}

```


Row {data-height=050; data-width=150}
-------------------------------------

### Total Óbitos 
```{r}
renderValueBox({
  
   total_obitos <- 0
   dados <- df_dados_totais()
   switch(input$FiltroAno,
          "2021" = {total_obito <-coalesce(sum(dados$tot_obito_2021),0)},
          "2022" = {total_obito <-coalesce(sum(dados$tot_obito_2022),0)},
          "2023" = {total_obito <-coalesce(sum(dados$tot_obito_2023),0)}
   )
   
  
   if (total_obito == 0) {
     valueBox(value = tags$p("---", style = "color:lightgray; "),
              caption = tags$p("Total", style = "color:lightgray;font-size: 20px; "),
              icon = icon("list"), color ="white")
   } else {
          valueBox(value = tags$p(format(total_obito, big.mark = "."), style = "font-size: 40px;font-size: 40px;"),
                   caption = tags$p("Total", style = "color:white;font-size: 20px; "),
                   icon = icon("list"), color ="red")
     
     
     }
   
  
})

```



### Média Idade 
```{r}
renderValueBox({
   
   media_idade <- 0
   dados <- df_dados_totais()
   switch(input$FiltroAno,
          "2021" = {media_idade <- round(mean(dados$obitos_md_idade_2021[dados$obitos_md_idade_2021>0]),1)},
          "2022" = {media_idade <- round(mean(dados$obitos_md_idade_2022[dados$obitos_md_idade_2022>0]),1)},
          "2023" = {media_idade <- round(mean(dados$obitos_md_idade_2023[dados$obitos_md_idade_2023>0]),1)}
)
   
   if (media_idade == 0 | is.nan(media_idade)) {
     valueBox(value = tags$p("---", style = "color:lightgray; "),
              captio = tags$p("Média Idade", style = "color:lightgray; "),
              icon = icon("list"), color ="white")
   } else {
      valueBox(value = media_idade,icon = icon("list"), color ="darkblue")    
     }
})

```

### Óbitos Sexo 

```{r}
renderValueBox({ 
   
   dados <- df_dados_totais()

   # 1- Masculino 2-Feminino 3-Ignorado
   
   switch(input$FiltroAno,
          "2021" = {sexo <- c(sum(dados$qt_sexo_M_2021), sum(dados$qt_sexo_F_2021), sum(dados$qt_sexo_I_2021))},
          "2022" = {sexo <- c(sum(dados$qt_sexo_M_2022), sum(dados$qt_sexo_F_2022), sum(dados$qt_sexo_I_2022))},
          "2023" = {sexo <- c(sum(dados$qt_sexo_M_2023), sum(dados$qt_sexo_F_2023), sum(dados$qt_sexo_I_2023))}
   )
   
   maior_sexo <- which(sexo == max(sexo))
   
   if (sum(sexo) != 0 ) {                       
         switch(maior_sexo[1],
                "1" = {valueBox(value = "Masculino", icon = icon("list"), color ="darkblue")},
                "2" = {valueBox(value = "Feminino ", icon = icon("list"), color ="pink")},
                "3" = {valueBox(value = "Ignorado ", icon = icon("list"), color ="green")},
                "0" = {valueBox(value = "   ---   ", color ="darkblue")} 
         )} else {valueBox(value = tags$p("---", style = "color:lightgray; "),
              caption = tags$p("Sexo", style = "color:lightgray; "),
              icon = icon("list"), color ="white")}
               
   
})
```

### Escolaridade
```{r}
renderValueBox({ 
  
# 0-Sem escolaridade/Analfabeto
# 1-Fundamental 1º ciclo (1ª a 5ª série)
# 2-Fundamental 2º ciclo (6ª a 9ª série)
# 3- Médio (1º ao 3º ano)
# 4-Superior
# 5-Não se aplica
# 9-Ignorado

dados <- df_dados_totais()

switch(input$FiltroAno,
 "2021" = {escola <- 
  c(sum(dados$qt_escola_0_2021),sum(dados$qt_escola_1_2021),sum(dados$qt_escola_2_2021),sum(dados$qt_escola_3_2021),sum(dados$qt_escola_4_2021),
    sum(dados$qt_escola_5_2021),sum(dados$qt_escola_9_2021))},
  "2022" = {escola <-  
  c(sum(dados$qt_escola_0_2022),sum(dados$qt_escola_1_2022),sum(dados$qt_escola_2_2022),sum(dados$qt_escola_3_2022),sum(dados$qt_escola_4_2022),
    sum(dados$qt_escola_5_2022),sum(dados$qt_escola_9_2022))},
  "2023" = {escola <- 
    c(sum(dados$qt_escola_0_2023),sum(dados$qt_escola_1_2023),sum(dados$qt_escola_2_2023),sum(dados$qt_escola_3_2023),sum(dados$qt_escola_4_2023),
    sum(dados$qt_escola_5_2023),sum(dados$qt_escola_9_2023))}
)
   

   maior_escola <- which(escola == max(escola))
                       
   if (sum(escola) != 0 ) {
   switch(maior_escola[1],
          "1" = {valueBox(value = "Analfabeto   ", icon = icon("list"), color ="darkblue")},
          "2" = {valueBox(value = "Fundamental 1", icon = icon("list"), color ="darkblue")},
          "3" = {valueBox(value = "Fundamental 2", icon = icon("list"), color ="darkblue")},
          "4" = {valueBox(value = "Ensino Médio ", color ="darkblue")},
          "5" = {valueBox(value = "Ens. Superior", icon = icon("list"), color ="darkblue")},
          "6" = {valueBox(value = "Não se aplica", icon = icon("list"), color ="darkblue")},
          "7" = {valueBox(value = "Ignorado     ", icon = icon("list"), color ="darkblue")}
   )}
   else {valueBox(value = tags$p("---", style = "color:lightgray; "),
              captio = tags$p("Escolaridade", style = "color:lightgray; "),
              icon = icon("list"), color ="white")}
   
})
```
    
### Raça
```{r}
renderValueBox({ 
dados <- df_dados_totais()

#  Raça 1-Branca  2-Preta 3-Amarela 4-Parda 5-Indígena 9-Ignorada
switch(input$FiltroAno,
  "2021" = {raca <- c(sum(dados$qt_raca_1_2021), sum(dados$qt_raca_2_2021), sum(dados$qt_raca_3_2021),sum(dados$qt_raca_4_2021), sum(dados$qt_raca_5_2021),sum(dados$qt_raca_9_2021))},
  "2022" = {raca <- c(sum(dados$qt_raca_1_2022), sum(dados$qt_raca_2_2022), sum(dados$qt_raca_3_2022),sum(dados$qt_raca_4_2022), sum(dados$qt_raca_5_2022),sum(dados$qt_raca_9_2022))},
  "2023" = {raca <- c(sum(dados$qt_raca_1_2023), sum(dados$qt_raca_2_2023), sum(dados$qt_raca_3_2023),sum(dados$qt_raca_4_2023), sum(dados$qt_raca_5_2023),sum(dados$qt_raca_9_2023))}
   )
   
   maior_raca <- which(raca == max(raca))
   
   if (sum(raca) != 0 ) {                       
         switch(maior_raca[1],
                "1" = {valueBox(value = "Branca  ", icon = icon("list"), color ="darkblue")},
                "2" = {valueBox(value = "Preta   ", icon = icon("list"), color ="pink")},
                "3" = {valueBox(value = "Amarela ", icon = icon("list"), color ="green")},
                "4" = {valueBox(value = "Parda   ", icon = icon("list"), color ="darkblue")},
                "5" = {valueBox(value = "Indígnea", icon = icon("list"), color ="pink")},
                "6" = {valueBox(value = "Ignorada", icon = icon("list"), color ="green")}
         )} else {valueBox(value = tags$p("---", style = "color:lightgray; "),
              captio = tags$p("Raça", style = "color:lightgray; "),
              icon = icon("list"), color ="white")}
})

```

